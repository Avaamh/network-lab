---
- name: Setup OpenLDAP and Bind on main server(supposed infra)
  hosts: server
  become: yes

  vars:
    ldap_domain: "lab.com"
    ldap_organization: "Lab Inc"
    ldap_password: "1"   # should be replaced with vault
    bind_forwarders:
      - "8.8.8.8"
      - "1.1.1.1"

  tasks:
    - name: Ensure debconf-utils is installed
      apt:
        name: debconf-utils
        state: present
        update_cache: yes

    # ------------------ OpenLDAP ------------------
    - name: Install OpenLDAP server and tools
      apt:
        name:
          - slapd
          - ldap-utils
        state: present
        update_cache: yes

    - name: Reconfigure slapd with debconf-set-selections
      debconf:
        name: slapd
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        - { question: "slapd/no_configuration", value: "false", vtype: "boolean" }
        - { question: "slapd/domain", value: "{{ ldap_domain }}", vtype: "string" }
        - { question: "slapd/organization", value: "{{ ldap_organization }}", vtype: "string" }
        - { question: "slapd/password1", value: "{{ ldap_password }}", vtype: "password" }
        - { question: "slapd/password2", value: "{{ ldap_password }}", vtype: "password" }
        - { question: "slapd/backend", value: "MDB", vtype: "select" }

    - name: Ensure slapd is reconfigured
      command: dpkg-reconfigure -f noninteractive slapd

    - name: Ensure slapd is enabled and running
      systemd:
        name: slapd
        state: started
        enabled: yes

    # ------------------ Bind DNS ------------------
    - name: Install bind9 DNS server
      apt:
        name: bind9
        state: present
        update_cache: yes

    - name: Configure named.conf.options
      copy:
        dest: /etc/bind/named.conf.options
        content: |
          options {
              directory "/var/cache/bind";

              recursion yes;
              allow-recursion { any; };
              forwarders {
                  {% for f in bind_forwarders %}
                  {{ f }};
                  {% endfor %}
              };
              dnssec-validation auto;

              listen-on { any; };
              listen-on-v6 { any; };
          };

    - name: Ensure bind9 is enabled and running
      systemd:
        name: bind9
        state: started
        enabled: yes
