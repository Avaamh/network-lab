---
- name: Install and configure OpenLDAP with Users and Groups
  hosts: server
  become: yes

  vars:
    ldap_domain: "lab.com"
    ldap_organization: "Lab Inc"
    ldap_admin_password: "AdminPass123"   # should be replaced with ansible-vault in real use
    base_dn: "dc=lab,dc=com"
    admin_dn: "cn=admin,{{ base_dn }}"

    ldap_users:
      - uid: jdoe
        cn: "John Doe"
        sn: "Doe"
        uidNumber: 10000
        gidNumber: 10000
        password: "UserPass1"
      - uid: asmith
        cn: "Alice Smith"
        sn: "Smith"
        uidNumber: 10001
        gidNumber: 10000
        password: "UserPass2"

    ldap_group:
      name: labgroup
      gidNumber: 10000
      members:
        - jdoe
        - asmith

  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - slapd
          - ldap-utils
          - debconf-utils
          - openssl
        state: present

    - name: Preseed slapd debconf values
      debconf:
        name: slapd
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        - { question: "slapd/no_configuration", value: "false", vtype: "boolean" }
        - { question: "slapd/domain", value: "{{ ldap_domain }}", vtype: "string" }
        - { question: "slapd/organization", value: "{{ ldap_organization }}", vtype: "string" }
        - { question: "slapd/password1", value: "{{ ldap_admin_password }}", vtype: "password" }
        - { question: "slapd/password2", value: "{{ ldap_admin_password }}", vtype: "password" }
        - { question: "slapd/backend", value: "MDB", vtype: "select" }

    - name: Reconfigure slapd non-interactively
      command: dpkg-reconfigure -f noninteractive slapd

    - name: Ensure slapd is started and enabled
      systemd:
        name: slapd
        state: started
        enabled: yes

    - name: Ensure /etc/ldap/ldap.conf has proper BASE and URI
      copy:
        dest: /etc/ldap/ldap.conf
        content: |
          BASE {{ base_dn }}
          URI ldap://127.0.0.1

    - name: Remove old OU=People if exists
      shell: |
        ldapdelete -x -D "{{ admin_dn }}" -w "{{ ldap_admin_password }}" "ou=People,{{ base_dn }}" || true
      args:
        executable: /bin/bash

    - name: Create base LDIF (domain + clean OUs)
      copy:
        dest: /tmp/base.ldif
        content: |
          dn: {{ base_dn }}
          objectClass: top
          objectClass: dcObject
          objectClass: organization
          o: {{ ldap_organization }}
          dc: {{ ldap_domain.split('.')[0] }}

          dn: ou=Users,{{ base_dn }}
          objectClass: organizationalUnit
          ou: Users

          dn: ou=Groups,{{ base_dn }}
          objectClass: organizationalUnit
          ou: Groups


    - name: Add base domain and OUs
      shell: |
        ldapadd -x -D "{{ admin_dn }}" -w "{{ ldap_admin_password }}" -f /tmp/base.ldif || true
      args:
        executable: /bin/bash





    - name: Ensure base OUs exist
      copy:
        dest: /tmp/base_ous.ldif
        content: |
          dn: ou=Users,dc=lab,dc=com
          objectClass: organizationalUnit
          ou: Users

          dn: ou=Groups,dc=lab,dc=com
          objectClass: organizationalUnit
          ou: Groups

    - name: Add base OUs if not exist
      shell: |
        ldapsearch -x -LLL -b "ou=Users,dc=lab,dc=com" dn >/dev/null 2>&1 || \
        ldapadd -x -D "{{ admin_dn }}" -w "{{ ldap_admin_password }}" -f /tmp/base_ous.ldif






    - name: Generate hashed passwords for users
      command: slappasswd -s "{{ item.password }}"
      register: pwhash_results
      loop: "{{ ldap_users }}"
      loop_control:
        label: "{{ item.uid }}"
      changed_when: false

    - name: Create LDIF files for users
      copy:
        dest: "/tmp/{{ item.item.uid }}.ldif"
        content: |
          dn: uid={{ item.item.uid }},ou=Users,{{ base_dn }}
          objectClass: inetOrgPerson
          objectClass: posixAccount
          objectClass: shadowAccount
          cn: {{ item.item.cn }}
          sn: {{ item.item.sn }}
          uid: {{ item.item.uid }}
          uidNumber: {{ item.item.uidNumber }}
          gidNumber: {{ item.item.gidNumber }}
          homeDirectory: /home/{{ item.item.uid }}
          loginShell: /bin/bash
          userPassword: {{ item.stdout }}
      loop: "{{ pwhash_results.results }}"
      loop_control:
        label: "{{ item.item.uid }}"

    - name: Add users if not exist
      command: ldapadd -x -D "{{ admin_dn }}" -w {{ ldap_admin_password }} -f /tmp/{{ item.uid }}.ldif
      loop: "{{ ldap_users }}"
      loop_control:
        label: "{{ item.uid }}"
      register: ldapadd_users
      failed_when: false
      changed_when: "'adding new entry' in ldapadd_users.stdout"

    - name: Create group LDIF
      copy:
        dest: /tmp/group.ldif
        content: |
          dn: cn={{ ldap_group.name }},ou=Groups,{{ base_dn }}
          objectClass: top
          objectClass: posixGroup
          cn: {{ ldap_group.name }}
          gidNumber: {{ ldap_group.gidNumber }}
          {% for m in ldap_group.members %}
          memberUid: {{ m }}
          {% endfor %}

    - name: Add group if not exists
      shell: |
        ldapsearch -x -LLL -H ldap://127.0.0.1 -b "cn={{ ldap_group.name }},ou=Groups,{{ base_dn }}" cn | grep '^cn:' >/dev/null 2>&1 || \
        ldapadd -x -D "{{ admin_dn }}" -w "{{ ldap_admin_password }}" -f /tmp/group.ldif
      args:
        executable: /bin/bash

    - name: Restart slapd to ensure changes applied
      systemd:
        name: slapd
        state: restarted

    - name: Show quick LDAP summary
      shell: ldapsearch -x -LLL -H ldap://127.0.0.1 -b "{{ base_dn }}" "(objectClass=*)" dn | sed -n '1,200p'
      register: ldap_summary
      changed_when: false

    - name: Print LDAP summary
      debug:
        var: ldap_summary.stdout_lines

